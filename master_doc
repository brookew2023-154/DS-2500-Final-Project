import pandas as pd 
import numpy as np 
from pathlib import Path
import re
import math
import matplotlib.pyplot as plt
import statsmodels.api as sm

class Scraping():
    
    def __init__(self, countyName, stateName, stateAbr, dataType):
        self.countyName = countyName
        self.stateName = stateName
        self.dataType = dataType
        self.stateAbr = stateAbr
        self.countyColumn = f"{self.countyName.replace('_', ' ')} County"
        
    def scrape(self):
        rural = ['Pend_Oreille', 'Garfield', 'Asotin', 'Talbot', 'Randolph', 'Clinch', 'Jasper', 'Gallatin', 'Vinton', 'Monroe', 'Morgan', 'Jackson', 'Sedgwick', 'Baca']
        suburban = ['Clark', 'Kitsap', 'Yakima', 'Whitfield', 'Walton', 'Bartow', 'McHenry', 'Winnebago', 'Madison', 'Butler', 'Stark', 'Lorain', 'Douglas', 'Larimer', 'Weld']
        urban = ['King', 'Spokane', 'Pierce', 'Fulton', 'Gwinnett', 'Cobb', 'Franklin', 'Cuyahoga', 'Cook', 'DuPage', 'Lake', 'El_Paso', 'Denver', 'Arapahoe']
        if self.stateAbr == 'IL':
            if 'Hamilton' not in rural: rural.append('Hamilton')
        elif self.stateAbr == 'OH':
            if 'Hamilton' not in urban: urban.append('Hamilton')
        base_directory = Path(__file__).parent
        filename = f"{self.stateName}/{self.dataType}_{self.countyName}_{self.stateAbr}.csv"
        filepath = base_directory/filename
        table = pd.read_csv(filepath, skiprows=1)
        table = table.dropna(axis = 0, how = 'any')

        if self.dataType == 'PC':
            extracted_values = (table[self.countyColumn]
                                .astype(str)
                                .str.extract(r'^(\d+)', expand=False) 
                                .astype(float) 
                               )
            cleaned_values = np.where(extracted_values > 0, 
                                      np.floor(100000 / extracted_values), 
                                      0) 
            table[self.countyColumn] = cleaned_values
            
        if self.dataType == 'VAX':
            valueVAX_cleaned = (table[self.countyColumn]
                                .astype(str)
                                .str.replace(r'\%$', '', regex=True) 
                                .astype(float) 
                               )
            table[self.countyColumn] = np.floor((valueVAX_cleaned / 100) * 100000)
        if self.countyName in rural:
            table['County Type'] = 'Rural'
        elif self.countyName in suburban:
            table['County Type'] = 'Suburban'  
        elif self.countyName in urban:
            table['County Type'] = 'Urban' 
        return table

class Hospitalizations():
    
    def __init__(self, stateName, stateAbr ):
        self.stateName = stateName
        self.stateAbr = stateAbr
        self.year_column = 'YEAR' 
        self.rate_column = 'WEEKLY RATE' 
        
    def hospitalizations (self, stateName, stateAbr):
        base_directory = Path(__file__).parent
        filename = f"{stateName}/ILINet_{stateAbr}.csv"
        filepath = base_directory/filename
        df = pd.read_csv(filepath, header=1)
        for col in ['ILITOTAL', 'TOTAL PATIENTS']:
            df[col] = pd.to_numeric(df[col], errors='coerce')
        df.dropna(subset=['ILITOTAL', 'TOTAL PATIENTS'], inplace=True)
        df = df[df['TOTAL PATIENTS'] > 0]
        df['Annual Flu Rate per 100k'] = (df['ILITOTAL'] / df['TOTAL PATIENTS']) * 100000
        return df

        
def merge_multi_county(tables_dict, data_type):
        first_table = tables_dict.values().__iter__().__next__()
        master_table = pd.DataFrame(first_table[['Year']])
        county_type_lookup = {}
        for key, table in tables_dict.items():
            county_name_file = key.replace(data_type, '')
            county_col = f"{county_name_file.replace('_', ' ')} County"
            county_type_lookup[county_col] = table['County Type'].iloc[0]
            data_to_merge = table[['Year', county_col]].copy()
            new_col_name = county_col.replace(' ', '_') 
            data_to_merge.rename(columns={county_col: new_col_name}, inplace=True)
            master_table = pd.merge(master_table, data_to_merge, on='Year', how='inner')
        return master_table 

def prepping_variable_data (stateName, stateAbr):
    coloradoCounties = ['Arapahoe', 'Baca', 'Denver', 'Douglas', 'El_Paso', 'Jackson', 'Larimer', 'Sedgwick', 'Weld']
    georgiaCounties = ['Bartow', 'Clinch', 'Cobb', 'Fulton', 'Gwinnett', 'Randolph', 'Talbot', 'Walton', 'Whitfield']
    illinoisCounties = ['Cook', 'DuPage','Gallatin', 'Hamilton', 'Jasper', 'Lake', 'Madison', 'McHenry', 'Winnebago']
    ohioCounties = ['Butler', 'Cuyahoga', 'Franklin', 'Hamilton', 'Lorain', 'Monroe', 'Morgan', 'Stark', 'Vinton']
    washingtonCounties = ['Asotin', 'Clark', 'Garfield', 'King', 'Kitsap', 'Pend_Oreille', 'Pierce', 'Spokane', 'Yakima']
    county_map = {
        'Colorado': coloradoCounties,
        'Georgia': georgiaCounties,
        'Illinois': illinoisCounties,
        'Ohio': ohioCounties,
        'Washington': washingtonCounties
    }
    counties_list = county_map[stateName]
    for county in counties_list:
        object_name_vax = f"{county}VAX"
        scraper_instance_vax = Scraping(county, stateName, stateAbr, 'VAX')
        tableVax = scraper_instance_vax.scrape()
        county_vax_scrapers[object_name_vax] = tableVax
        object_name_pc = f"{county}PC"
        scraper_instance_pc = Scraping(county, stateName, stateAbr, 'PC')
        tablePC = scraper_instance_pc.scrape()
        county_PC_scrapers[object_name_pc] = tablePC
        
def linear_regression (stateName, stateAbr, state_hospitalization_df):
    state_hospitalization_df['YEAR'] = pd.to_numeric(
        state_hospitalization_df['YEAR'], errors='coerce'
    ).astype(int)
    annual_flu_rate = state_hospitalization_df.groupby('YEAR')['Annual Flu Rate per 100k'].mean().reset_index()
    annual_flu_rate.rename(columns={'YEAR': 'Year'}, inplace=True)
    merged_vax_table['Year'] = pd.to_numeric(
        merged_vax_table['Year'], errors='coerce'
    ).astype(int)
    merged_pc_table['Year'] = pd.to_numeric(
        merged_pc_table['Year'], errors='coerce'
    ).astype(int)
    coloradoCounties = ['Arapahoe', 'Baca', 'Denver', 'Douglas', 'El_Paso', 'Jackson', 'Larimer', 'Sedgwick', 'Weld']
    georgiaCounties = ['Bartow', 'Clinch', 'Cobb', 'Fulton', 'Gwinnett', 'Randolph', 'Talbot', 'Walton', 'Whitfield']
    illinoisCounties = ['Cook', 'DuPage','Gallatin', 'Hamilton', 'Jasper', 'Lake', 'Madison', 'McHenry', 'Winnebago']
    ohioCounties = ['Butler', 'Cuyahoga', 'Franklin', 'Hamilton', 'Lorain', 'Monroe', 'Morgan', 'Stark', 'Vinton']
    washingtonCounties = ['Asotin', 'Clark', 'Garfield', 'King', 'Kitsap', 'Pend_Oreille', 'Pierce', 'Spokane', 'Yakima']
    county_map = {
        'Colorado': coloradoCounties,
        'Georgia': georgiaCounties,
        'Illinois': illinoisCounties,
        'Ohio': ohioCounties,
        'Washington': washingtonCounties
    }
    counties_list = county_map[stateName]
    vax_cols = [f'{county}_County' for county in counties_list] 
    annual_avg_vax_rate_state = merged_vax_table[vax_cols].mean(axis=1)
    annual_vax_rate = pd.DataFrame({
        'Year': merged_vax_table['Year'], 
        'Annual_Avg_VAX_Rate': annual_avg_vax_rate_state
    })
    regression_data = pd.merge(annual_flu_rate, annual_vax_rate, on='Year', how='inner')
    regression_data = regression_data.replace([np.inf, -np.inf], np.nan).dropna()
    Y = regression_data['Annual Flu Rate per 100k']
    X = regression_data['Annual_Avg_VAX_Rate']
    X = sm.add_constant(X)
    model = sm.OLS(Y, X)
    vax_results = model.fit()
    pc_cols = [f'{county}_County' for county in counties_list] 
    annual_avg_pc_rate_state = merged_pc_table[pc_cols].mean(axis=1) 
    annual_pc_rate = pd.DataFrame({
        'Year': merged_pc_table['Year'], 
        'Annual_Avg_PC_Rate': annual_avg_pc_rate_state
    })
    regression_data = pd.merge(annual_flu_rate, annual_pc_rate, on='Year', how='inner')
    regression_data = regression_data.replace([np.inf, -np.inf], np.nan).dropna()
    Y = regression_data['Annual Flu Rate per 100k']
    X = regression_data['Annual_Avg_PC_Rate']
    X = sm.add_constant(X)
    model = sm.OLS(Y, X)
    pc_results = model.fit()
    print(f"---------------{stateName}------------")
    vax_percent = round(vax_results.rsquared * 100, 2)
    pc_percent = round(pc_results.rsquared * 100, 2)
    print(f'The influence that vaccinations have on state influenza hospital admissions for {stateName} is {vax_percent}%')
    print(f'The influence that access to primary care physicans have on state influenza hospital admissions for {stateName} is {pc_percent}%')


county_vax_scrapers = {}
county_PC_scrapers = {}

prepping_variable_data('Colorado', 'CO')
prepping_variable_data('Georgia', 'GA')
prepping_variable_data('Illinois', 'IL')
prepping_variable_data('Ohio', 'OH')
prepping_variable_data('Washington', 'WA')

merged_pc_table = merge_multi_county(county_PC_scrapers, 'PC')
merged_vax_table = merge_multi_county(county_vax_scrapers, 'VAX')


initialize_hospitalizations_CO = Hospitalizations("Colorado", "CO")
hospitalizations_CO = initialize_hospitalizations_CO.hospitalizations('Colorado', 'CO')

initialize_hospitalizations_IL = Hospitalizations("Illinois", "IL")
hospitalizations_IL = initialize_hospitalizations_IL.hospitalizations('Illinois', 'IL')

initialize_hospitalizations_GA = Hospitalizations("Georgia", "GA")
hospitalizations_GA = initialize_hospitalizations_GA.hospitalizations('Georgia', 'GA')

initialize_hospitalizations_OH = Hospitalizations("Ohio", "OH")
hospitalizations_OH = initialize_hospitalizations_OH.hospitalizations('Ohio', 'OH')

initialize_hospitalizations_WA = Hospitalizations("Washington", "WA")
hospitalizations_WA = initialize_hospitalizations_WA.hospitalizations('Washington', 'WA')


linear_regression('Colorado', 'CO', hospitalizations_CO)
linear_regression('Georgia', 'GA', hospitalizations_GA)
linear_regression('Illinois', 'IL', hospitalizations_IL)
linear_regression('Ohio', 'OH', hospitalizations_OH)
linear_regression('Washington', 'WA', hospitalizations_WA)
